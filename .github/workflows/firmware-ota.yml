name: Firmware OTA Pipeline

on:
  push:
    paths:
      - 'src/**'
      - 'platformio.ini'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'src/**'
      - 'platformio.ini'

env:
  FIRMWARE_BUCKET: esp32-firmware-ota-1754784838.95337
  BACKEND_API_URL: https://29krajp8ai.execute-api.us-east-1.amazonaws.com/prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Extract firmware version
      id: version
      run: |
        VERSION=$(grep '#define FIRMWARE_VERSION' src/secrets.h | cut -d'"' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Firmware version: $VERSION"
        
    - name: Build firmware
      run: |
        pio run
        
    - name: Generate checksum
      id: checksum
      run: |
        CHECKSUM=$(sha256sum .pio/build/esp32dev/firmware.bin | cut -d' ' -f1)
        echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
        echo "Firmware checksum: $CHECKSUM"
        
    - name: Show firmware info
      run: |
        echo "Firmware built successfully!"
        echo "Version: ${{ steps.version.outputs.version }}"
        echo "Checksum: ${{ steps.checksum.outputs.checksum }}"
        echo "File size: $(stat -c%s .pio/build/esp32dev/firmware.bin) bytes"
          
    - name: Create release (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: SmartHomeHub v${{ steps.version.outputs.version }}
        body: |
          ## SmartHomeHub Firmware v${{ steps.version.outputs.version }}
          
          **Build Info:**
          - Commit: ${{ github.sha }}
          - Build Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Checksum: ${{ steps.checksum.outputs.checksum }}
          
          **Changes:**
          - Automated build from latest commit
          
          **OTA Deployment:**
          - Firmware uploaded to S3
          - Backend notified for canary rollout
          - Monitor device telemetry for rollout status
        draft: false
        prerelease: false
        files: .pio/build/esp32dev/firmware.bin
        
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-v${{ steps.version.outputs.version }}
        path: .pio/build/esp32dev/firmware.bin
        retention-days: 30